# Pandora FMS 3.0 Server Installer (c) 2008-2009 Artica ST
# Please see http://www.pandorafms.org
# This code is licensed under GPL 2.0 license.
# **********************************************************************

#!/bin/bash

MODE=$1
SECOPT=$2

install () {

perl Makefile.PL > output 2>&1  #&& sleep 2 &&  cat output | grep "found" | wc -l 

DEPENDENCIAS=`cat output | grep "found" | wc -l`

if [ $DEPENDENCIAS -gt 0 ]
then

	echo "You are missing the following dependencies"
	echo " "
	cat output | awk -F ": prerequisite" '{print $2}' | awk -F " " '{print $1}'
	echo "The complete installation guide is at: "http://www.openideas.info/wiki/index.php?title=Pandora_2.0:Documentation_en:Install_Server#Pandora_FMS_Server_installation" "
	echo " "
	echo "Debian-based distribution do:"
	echo "	$ apt-get install libdate-manip-perl snmp snmpd libsnmp-perl libtime-format-perl libxml-simple-perl libnetaddr-ip-perl libdbi-perl libxml-simple-perl libnetaddr-ip-perl libhtml-parser-perl wmi-client xprobe2 libmail-sendmail-perl"
	echo " "
	echo "RedHat-based distribution do"
	echo " "
	echo "	$ yum perl-XML-SAX* perl-Tie* perl-XML-Simple* perl-DateManip* perl-IO-Socket* perl-Time-modules* perl-NetAddr-IP* perl-GD* perl-DateTime* perl-ExtUtils"
	echo " "
	echo "To get it from source through CPAN do"
	echo " "
	echo "  $ cpan Digest::MD5 Time::Local DBI threads threads::shared IO::Socket Time::HiRes Time::Format Net::Ping NetAddr::IP Mail::Sendmail Net::Traceroute::PurePerl HTML::Entities"
	echo " "
	rm output
else
	make
	make install
	mkdir /var/spool/pandora
	mkdir /var/spool/pandora/data_in
	id pandora
	if [ $? -eq 0 ]; then
		echo " "
		echo "User pandora does exist, make sure the SSH directories are correct"
	else
		useradd pandora
		mkdir /home/pandora
		mkdir /home/pandora/.ssh
		chown -R pandora /home/pandora
	fi
	mkdir /var/log/pandora
	chown pandora:wheel /var/spool/pandora/data_in > /dev/null 2>&1 || chown pandora:root /var/spool/pandora/data_in
	chmod 770 /var/spool/pandora/data_in
	mkdir /etc/pandora
	if [ -e /etc/pandora/pandora_server.conf ]; then
		echo "Old installation detected, backing up pandora_server.conf"
		mv /etc/pandora/pandora_server.conf /etc/pandora/pandora_server.conf.bak
	fi
	cp conf/pandora_server.conf /etc/pandora/
	chmod 770 /etc/pandora/pandora_server.conf
	if [ "`uname -s`" != "Linux" ]; then
		echo "This is not a Linux-based distro. The installer will not create files for automatic startup."
		echo "Copying the binaries into /usr/local/bin"
		cp pandora_server /usr/local/bin
	else 
		echo "Copying the startup scripts into /etc/init.d and linking it to /etc/rc2.d"
		cp pandora_server /etc/init.d/
		ln -s /etc/init.d/pandora_server /etc/rc2.d/S90pandora_server
	fi

	if [ -e /usr/local/bin/pandora_server ]
	then
		ln -s /usr/local/bin/pandora_server /usr/bin/pandora_server
		ln -s /usr/bin/pandora_server /usr/local/bin/pandora_server
	fi


	if [ "$SECOPT" != "--no-tentacle" ]
	then
		# Tentacle server install
		echo "Installing tentacle server in /etc/rc2.d/S80tentacle_serverd"
		cp bin/tentacle_server /usr/local/bin
		cp util/tentacle_serverd /etc/init.d/tentacle_serverd
		ln -s /etc/init.d/tentacle_serverd /etc/rc2.d/S80tentacle_serverd
	fi

	mkdir /usr/share/pandora
	cp -R util /usr/share/pandora
	if [ -d /etc/cron.daily ]
	then
		echo "#!/bin/bash" > /etc/cron.daily/pandora_purge_db	
		echo "perl /usr/share/pandora/util/pandora_db.pl /etc/pandora/pandora_server.conf" >> /etc/cron.daily/pandora_purge_db	
		chmod +x /etc/cron.daily/pandora_purge_db
	else
		echo "You're probably not using cron for automatic scheduling. You should schedule the following command to run frequently (daily) on your master server:"
		echo "   perl /usr/share/pandora/util/pandora_db.pl /etc/pandora/pandora_server.conf"
	fi
	rm output
fi

}

uninstall () {
	if [ "`uname -s`" != "Linux" ]; then
			echo "This is not a Linux-based distro. Uninstaller is currently not working for your OS"
	fi
	echo "Removing Pandora Servers"
		rm -Rf /var/spool/pandora/data_in/

	echo "If the user Pandora is not being used for any other operations, please delete using the following commands:"
	echo "   userdel pandora"
	echo "   rm -Rf /home/pandora/"
        ## Just to clarify here. Some people (like me) are using the pandora user for other purposes and/or using an LDAP-based user management
	## I would hate to have a script clear out this users' information without any notification

	rm -Rf /var/log/pandora/  2> /dev/null 
	rm -Rf /etc/pandora/pandora_server.conf  2> /dev/null
	rm -Rf /etc/init.d/pandora_server  2> /dev/null 

	rm -Rf /etc/rc2.d/S90pandora_server  2> /dev/null 

	rm -Rf /usr/local/bin/pandora_server  2> /dev/null

	rm -Rf /usr/bin/pandora_server 2> /dev/null

	rm -Rf /usr/share/pandora
	rm -Rf /etc/cron.daily/pandora_purge_db

	echo "Done"
}

help () {
        echo "     --install           To install Pandora FMS Servers on this system (You have to be root)"
        echo "     --uninstall         To uninstall and remove Pandora FMS Servers on this System"
	echo " "
	echo " Additional parameters (after --install) "
        echo " "
	echo "     --no-tentacle        Skip tentacle server installation (by default tentacle server installed)"
	echo " "
}

# Script banner at start
echo " "
echo "Pandora FMS 3.0 Server Installer (c) 2008-2009 Artica ST"
echo "This program is licensed under GPL2 Terms. http://pandorafms.org"
echo " "

case "$MODE" in

'--install')
        install
        exit
        ;;

'--uninstall')
        uninstall
        exit
        ;;

*)
        help
esac

