# Pandora FMS 3.0 Server Installer (c) 2009 Artica ST
# Please see http://www.pandorafms.com
# This code is licensed under GPL 2.0 license.
# **********************************************************************

#!/bin/bash

MODE=$1

install () {

	echo "Installing new libraries and server executables...."
	perl Makefile.PL
	make
	make install

	echo "Setting permissions..."

	chmod 750 bin/*
	chmod 750 pandora_* 
	chmod 750 util/*.pl
	chmod 750 util/*.sh
	chmod 750 util/tentacle_serverd
	chmod 750 util/pandora_server
	chmod 750 util/plugin/*

	echo "Copying utilities...."
	cp -R util /usr/share/pandora_server
	cp bin/pandora_exec /usr/local/bin
	
	echo "Rebuilding links /usr/local/bin -> /usr/bin"
	rm /usr/bin/pandora_server
	rm /usr/bin/pandora_exec
	ln -s /usr/local/bin/pandora_server /usr/bin
	ln -s /usr/local/bin/pandora_exec /usr/bin	
	ln -s /usr/local/bin/tentacle_server /usr/bin

	if [ -d /etc/logrotate.d ]; then
		echo "Creating logrotate.d entry for Pandora FMS log management"
		cp util/pandora_logrotate /etc/logrotate.d/pandora
	else
		echo "Please add a log rotation schedule manually to your log rotation daemon (if any)"
	fi

	echo "Copying startup scripts to /etc/init.d...."
	cp util/pandora_server /etc/init.d
	cp util/tentacle_serverd /etc/init.d

	if [ ! -e  /etc/cron.daily/pandora_purge_db ]
	then
		echo "You don't have a /etc/cron.daily/pandora_purge_db file, you should consider"
		echo "to setup the Pandora FMS daily Database Maintance script: "
		echo "   perl /usr/share/pandora_server/util/pandora_db.pl /etc/pandora/pandora_server.conf"
	fi

	echo " "
	echo "DONE!. Don't forget to restart all your Pandora FMS servers running in this machine"
	echo " "
}

help () {
        echo "     --upgrade           To upgrade Pandora FMS Servers on this system (You have to be root)"
        echo " "
}

# Script banner at start
echo " "
echo "Pandora FMS 2.0 Server Upgrade (c) 2009 Artica ST"
echo "This program is licensed under GPL2 Terms. http://pandorafms.com"
echo " "

case "$MODE" in

'--upgrade')
        install
        exit
        ;;

*)
        help
esac

